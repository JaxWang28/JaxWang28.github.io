<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Valgrind åŸºç¡€ä»‹ç»ä¸æ¡†æ¶æ¦‚è§ˆ | Jackson Blog</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/github-markdown-light.css" />
    
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/site.webmanifest">


      <script async src="https://www.googletagmanager.com/gtag/js?id=7S26TLKGMX"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '7S26TLKGMX');
        }
      </script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/post/">Posts</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/bookshelf">Bookshelf</a></li>
      
      <li><a href="/index.xml">RSS</a></li>
      
    </ul>
    <hr/>
    </nav>

<div style="margin-left: auto; margin-right: 0; text-align: right;" >
  ğŸ“…
   2025/04/19 
  &nbsp

  <span id="busuanzi_container_page_pv">
  ğŸ‘€<span id="busuanzi_value_page_pv"></span>
  </span> 
</div>
<div class="markdown-box">
<main class="markdown-body">
<h1 id="valgrind-åŸºç¡€ä»‹ç»ä¸æ¡†æ¶æ¦‚è§ˆ">Valgrind åŸºç¡€ä»‹ç»ä¸æ¡†æ¶æ¦‚è§ˆ</h1>
<p>Valgrindæ˜¯ä¸€æ¬¾ç”¨äºå†…å­˜è°ƒè¯•ã€å†…å­˜æ³„æ¼æ£€æµ‹ä»¥åŠæ€§èƒ½åˆ†æçš„è½¯ä»¶å¼€å‘å·¥å…·ï¼Œæœ¬æ–‡ç®€å•åˆ†æ Valgrind åŸºæœ¬åŸç†åŠå…¶æ¡†æ¶ç»„æˆï¼Œå¹¶è®°å½•å…¶åœ¨åµŒå…¥å¼è®¾å¤‡ä¸Šçš„ç§»æ¤ä¸è°ƒè¯•è¿‡ç¨‹ã€‚</p>
<center>
<img src="https://img.jaxwang.top/2025/05/58dd96be77f8cf9442f0177a402fc258.png" width="50%" height="50%">
</center>
<h2 id="ä¸€æ’æ¡©æŠ€æœ¯æ¦‚è¿°">ä¸€ã€æ’æ¡©æŠ€æœ¯æ¦‚è¿°</h2>
<p><a href="https://en.wikipedia.org/wiki/Instrumentation_(computer_programming)">æ’æ¡©</a>ï¼ˆinstrumentationï¼‰æŠ€æœ¯æ˜¯æŒ‡<strong>åœ¨ç¨‹åºæºç æˆ–äºŒè¿›åˆ¶ä»£ç ä¸­æ’å…¥ç›‘æµ‹ä»£ç </strong>å®ç°å¯¹ç¨‹åºçš„ç›‘è§†ã€‚è¾¾åˆ°è®°å½•å‡½æ•°è¿›å…¥å’Œé€€å‡ºã€ç›‘æ§å†…å­˜è¯»å†™ã€ç»Ÿè®¡æ‰§è¡Œæ—¶é—´ã€è·Ÿè¸ªå¼‚å¸¸ç­‰ã€‚</p>
<p>æ’æ¡©åœ¨å®ç°ä¸Šå¯åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ol>
<li>é™æ€æ’æ¡© Static Instrumentationï¼šåœ¨ç¨‹åºç¼–è¯‘ä¹‹å‰æˆ–ç¼–è¯‘æœŸé—´æ’å…¥ä»£ç ï¼Œå³åœ¨<strong>æºä»£ç æˆ–ä¸­é—´ä»£ç </strong>ä¸­æ’å…¥æ£€æµ‹ä»£ç ï¼Œæœ€ç»ˆç¼–è¯‘æˆå¸¦æœ‰æ’æ¡©çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
<li>åŠ¨æ€æ’æ¡© Dynamic Binary Instrumentation DBIï¼šåœ¨ç¨‹åºè¿è¡Œä¸­è¿›è¡Œæ’æ¡©ï¼Œå…¶æ“ä½œå¯¹è±¡ä¸º<strong>æœºå™¨ç </strong>ã€‚åŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©å·¥å…·ä¸»è¦åŒ…å« Pinï¼ŒValgrindï¼ŒDynamoRIO ç­‰ã€‚</li>
</ol>
<h2 id="äºŒvalgrind-framework">äºŒã€Valgrind Framework</h2>
<p>Valgrind æœ¬è´¨ä¸Šæ˜¯ä¸€å¥—æ ¸å¿ƒæ¡†æ¶ frameworkï¼Œå…¶æä¾›äº†æ ¸å¿ƒ Core åŠ APIs ï¼Œåœ¨æ­¤æ¡†æ¶åŸºç¡€ä¸Šå¼€å‘å‡º 7 ä¸ªå·¥å…·ï¼š</p>
<center>
<img src="https://img.jaxwang.top/2025/05/ca0ba156ff8f0203ba14b1e713ea4318.png" width="50%" height="50%">
</center>
<table>
  <thead>
      <tr>
          <th>å·¥å…·</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Memcheck</td>
          <td>å†…å­˜é”™è¯¯æ£€æµ‹ï¼Œç”¨äºæ£€æµ‹å†…å­˜æ³„æ¼ã€è¶Šç•Œè®¿é—®ã€ä½¿ç”¨æœªåˆå§‹åŒ–å†…å­˜ç­‰å†…å­˜ç›¸å…³é”™è¯¯</td>
      </tr>
      <tr>
          <td>Helgrind</td>
          <td>çº¿ç¨‹é”™è¯¯æ£€æµ‹ï¼Œæ£€æµ‹æ•°æ®ç«äº‰ï¼ˆrace conditionsï¼‰å’Œæ­»é”</td>
      </tr>
      <tr>
          <td>DRD</td>
          <td>çº¿ç¨‹é”™è¯¯æ£€æµ‹ï¼Œä½¿ç”¨ä¸ Helgrind ä¸åŒæŠ€æœ¯</td>
      </tr>
      <tr>
          <td>Cachegrind</td>
          <td>ç¼“å­˜å’Œåˆ†æ”¯é¢„æµ‹åˆ†æ</td>
      </tr>
      <tr>
          <td>Callgrind</td>
          <td>åŸºäº Cachegrindï¼Œä½†é¢å¤–ç”Ÿæˆè°ƒç”¨å›¾ï¼Œåˆ†æå‡½æ•°è°ƒç”¨åŠå…¶æ€§èƒ½å½±å“</td>
      </tr>
      <tr>
          <td>Massif</td>
          <td>å †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·ï¼Œå¸®åŠ©æ‰¾å‡ºå†…å­˜ä½¿ç”¨é«˜å³°åŠå…¶æ¥æº</td>
      </tr>
      <tr>
          <td>DHAT</td>
          <td>åˆ†æå †å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„è¯¦ç»†æƒ…å†µ</td>
      </tr>
  </tbody>
</table>
<h2 id="ä¸‰åµŒå…¥å¼å¹³å°è°ƒè¯•-memory-leak">ä¸‰ã€åµŒå…¥å¼å¹³å°è°ƒè¯• memory leak</h2>
<ol>
<li>æŒ‡å®š <code>toolchains</code></li>
</ol>
<pre><code>export GCC_PATH=/your_path_for_linaro/bin
export CC=${GCC_PATH}/aarch64-linux-gnu-gcc
export LD=${GCC_PATH}/aarch64-linux-gnu-ld
export AR=${GCC_PATH}/aarch64-linux-gnu-ar
</code></pre>
<ol start="2">
<li>ç¼–è¯‘é…ç½®</li>
</ol>
<pre><code>cd valgrind
./autogen.sh
./configure --prefix=`pwd`/Inst --host=aarch64-unknown-linux --enable-only64bit
</code></pre>
<ol start="3">
<li>ç¼–è¯‘å®‰è£…</li>
</ol>
<pre><code>make -j4 install
</code></pre>
<ol start="4">
<li>å‡†å¤‡å¸¦æœ‰ debug info çš„ <code>ld.so</code></li>
</ol>
<p><code>valgrind memcheck</code> éœ€è¦ä½¿ç”¨å¸¦è°ƒè¯•ä¿¡æ¯çš„ <code>ld.so</code>ï¼Œ å…¶ä¼šæ‹¦æˆªå¹¶æ›¿æ¢ ld.so ä¸­çš„æŸäº›ç¬¦å·ï¼ˆæ¯”å¦‚ strlenï¼‰ä»¥å®ç°æ­£ç¡®çš„æ£€æµ‹[1]ã€‚ å¦åˆ™ä¼šæŠ¥ <code>cannot be set up</code> é”™è¯¯ï¼Œ<code>ld.so</code> å¯ä»¥åœ¨äº¤å‰ç¼–è¯‘å·¥å…·é“¾ä¸­æ‰¾åˆ°ã€‚</p>
<pre><code>$ find . -name &quot;*ld*.so&quot;
./aarch64-linux-gnu/libc/lib/ld-2.25.so
$ file ./aarch64-linux-gnu/libc/lib/ld-
ld-2.25.so             ld-linux-aarch64.so.1
$ file ./aarch64-linux-gnu/libc/lib/ld-2.25.so
./aarch64-linux-gnu/libc/lib/ld-2.25.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked, BuildID[sha1]=73b23c16ff9fe3eab046636cd9dd6db9d3309f27, with debug_info, not stripped
</code></pre>
<ol start="5">
<li>å¼€å§‹æ£€æµ‹</li>
</ol>
<p>å°†ç¼–è¯‘äº§ç”Ÿçš„å·¥å…·ç›®å½•å’Œ <code>ld.so</code> æ”¾å…¥æ¿å­ï¼Œå¯åŠ¨ valgrind.</p>
<pre><code>export VALGRIND_LIB=/libexec/valgrind &amp;&amp; valgrind --tool=memcheck --leak-check=full /tmp/ld-2.28.so program
</code></pre>
<p>å¦‚æœè°ƒè¯•çš„ daemon ç¨‹åºï¼Œå¯ä»¥åœ¨è¿è¡Œä¸€æ®µæ—¶é—´åé€šè¿‡ <code>SIGTERM</code> ä¿¡å·ç»ˆæ­¢ <code>valgrind</code> è·å–ç»“æœã€‚</p>
<h2 id="references">References</h2>
<p>[1] <a href="https://valgrind.org/docs/manual/dist.readme-packagers.html">https://valgrind.org/docs/manual/dist.readme-packagers.html</a></p>
<p>[2] valgrind.org <a href="https://valgrind.org/">https://valgrind.org/</a></p>
<p>[3] <a href="https://www.cnblogs.com/yucloud/p/armbuild_valgrind3.html">https://www.cnblogs.com/yucloud/p/armbuild_valgrind3.html</a></p>
<p>[4] <a href="https://valgrind.org/downloads/repository.html">https://valgrind.org/downloads/repository.html</a></p>
<p>[5] è®ºæ–‡ æ¨¡ç³Šæµ‹è¯•ä¸­çš„é™æ€æ’æ¡©æŠ€æœ¯ <a href="https://crad.ict.ac.cn/cn/article/pdf/preview/10.7544/issn1000-1239.202220883.pdf">https://crad.ict.ac.cn/cn/article/pdf/preview/10.7544/issn1000-1239.202220883.pdf</a></p>
<p>[6] è®ºæ–‡ Valgrind: A Framework for Heavyweight Dynamic Binary Instrumentation <a href="https://valgrind.org/docs/valgrind2007.pdf">https://valgrind.org/docs/valgrind2007.pdf</a></p>
<p>[7] <a href="https://zhuanlan.zhihu.com/p/382100526">https://zhuanlan.zhihu.com/p/382100526</a></p>
<p>[8] <a href="https://robotchaox.github.io/linux-tool/valgrind%E5%86%85%E5%AD%98%E6%A3%80%E6%B5%8B.html">https://robotchaox.github.io/linux-tool/valgrind%E5%86%85%E5%AD%98%E6%A3%80%E6%B5%8B.html</a></p>
<p>[9] <a href="https://www.semanticscholar.org/paper/Runtime-Overhead-Reduction-in-Automated-Parallel-Hoshi-Ootsu/3035e38a830e14daf02d55c13037f101e55b0246">https://www.semanticscholar.org/paper/Runtime-Overhead-Reduction-in-Automated-Parallel-Hoshi-Ootsu/3035e38a830e14daf02d55c13037f101e55b0246</a></p>

</main>
</div>

<br>

<script src="https://giscus.app/client.js"
        data-repo="JaxWang28/Blog"
        data-repo-id="R_kgDOIbrexg"
        data-category="Announcements"
        data-category-id="DIC_kwDOIbrexs4CSjN8"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>

  <footer>
  <hr/>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="//cdn.jsdelivr.net/combine/npm/katex/dist/katex.min.js,npm/katex/dist/contrib/auto-render.min.js,npm/@xiee/utils/js/render-katex.js" defer></script>

<script src="//cdn.jsdelivr.net/npm/@xiee/utils/js/center-img.min.js" defer></script>


<div class="busuanzi-footer">
  <span id="busuanzi_container_site_pv">
    æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡
  </span>
  <span id="busuanzi_container_site_uv">
    è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äººæ¬¡
  </span>
</div>
  
  <hr/>
  Â© <a href="https://jaxwang28.github.io">Jackson Wang</a> 2017 &ndash; 2025 | <a href="https://github.com/jaxwang28">Github</a>
  
  </footer>
  </body>
</html>

