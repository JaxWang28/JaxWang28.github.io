<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>Linux Kernel æ•°æ®ç»“æ„åˆ†æä¹‹é“¾è¡¨</title>
    <meta name="description" content="Linux Kernel å†…æ ¸ä¸­é“¾è¡¨å®ç°åŠå…¶å®ç°åŸç†ã€‚">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/github-markdown-light.css" />
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

  </head>

  <body>
    <nav>
      <ul class="menu">
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/post/">Posts</a></li>
        
        <li><a href="/categories/">Categories</a></li>
        
        <li><a href="/tags/">Tags</a></li>
        
        <li><a href="/about/">About</a></li>
        
        <li><a href="/bookshelf">Bookshelf</a></li>
        
        <li><a href="/index.xml">RSS</a></li>
        
      </ul>
      <hr/>
    </nav>

<div style="margin-left: auto; margin-right: 0; text-align: right;" >
  ğŸ“…
   2025/04/30 
</div>
<div class="markdown-box">
<main class="markdown-body">
<h1 id="linux-kernel-æ•°æ®ç»“æ„åˆ†æä¹‹é“¾è¡¨">Linux Kernel æ•°æ®ç»“æ„åˆ†æä¹‹é“¾è¡¨</h1>
<p>Linux Kernel ä¸­å®ç°äº†ä»¥ä¸‹ä¸¤ç§é“¾è¡¨ï¼š</p>
<ul>
<li>åŒå‘å¾ªç¯é“¾è¡¨</li>
<li>hash é“¾è¡¨</li>
</ul>
<p>æœ¬æ–‡å°†åˆ†åˆ«åˆ†æä¸¤ç§é“¾è¡¨çš„å®ç°ã€‚</p>
<h2 id="ä¸€åŒå‘å¾ªç¯é“¾è¡¨">ä¸€ã€åŒå‘å¾ªç¯é“¾è¡¨</h2>
<p>Linux ä½¿ç”¨äº†æœ€ç®€æ´çš„æ–¹å¼å®ç°äº†ä¸€ä¸ªå‡ ä¹æ˜¯ä¸‡èƒ½çš„é“¾è¡¨ï¼Œå…¶é€šè¿‡å°† <code>struct list_head</code> <strong>åµŒå…¥åˆ°å…¶ä»–ç»“æ„ä½“ä¸­</strong>ï¼Œå®ç°åŒå‘å¾ªç¯é“¾è¡¨ã€‚å¹¶åœ¨ <code>include/linux/list.h</code> å®šä¹‰äº†æ”¯æŒçš„æ‰€æœ‰æ“ä½œã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/types.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> list_head {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> list_head <span style="color:#f92672">*</span>next, <span style="color:#f92672">*</span>prev;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥ <code>keme_caches</code> é“¾è¡¨è¿›è¡Œåˆ†æã€‚</p>
<pre tabindex="0"><code>// mm/slab_common.c

LIST_HEAD(slab_caches);
</code></pre><pre tabindex="0"><code>// mm/slab.h

struct kmem_cache {
    ....
    struct list_head list;		/* List of slab caches */
    ....
}
</code></pre><center><img src="https://img.jaxwang.top/2025/04/c8590fa84ab49e876bb5296f2dc13712.png" width="70%" height="70%"> </center>
<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒæŒ‡é’ˆæŒ‡å‘æ˜¯ <code>struct kmem_cache</code> ä¸­ <code>list</code> æˆå‘˜ã€‚é€šè¿‡è¿™ä¸ªæˆå‘˜çš„åœ°å€è·å¾— <code>struct kmem_cache</code> çš„åœ°å€çš„æ“ä½œï¼Œåœ¨ Linux ä¸­é€šè¿‡ <code>list_entry</code> å®ç°ã€‚ä¸‹é¢åˆ†æå…¶å®ç°é€»è¾‘ã€‚</p>
<pre tabindex="0"><code>// include/linux/list.h

/**
 * list_entry - get the struct for this entry
 * @ptr:	the &amp;struct list_head pointer.
 * @type:	the type of the struct this is embedded in.
 * @member:	the name of the list_head within the struct.
 */
#define list_entry(ptr, type, member) \
	container_of(ptr, type, member)
</code></pre><pre tabindex="0"><code>// include/linux/container_of.h

/**
 * container_of - cast a member of a structure out to the containing structure
 * @ptr:	the pointer to the member.
 * @type:	the type of the container struct this is embedded in.
 * @member:	the name of the member within the struct.
 *
 * WARNING: any const qualifier of @ptr is lost.
 */
#define container_of(ptr, type, member) ({				\
	void *__mptr = (void *)(ptr);					\
	static_assert(__same_type(*(ptr), ((type *)0)-&gt;member) ||	\
		      __same_type(*(ptr), void),			\
		      &#34;pointer type mismatch in container_of()&#34;);	\
	((type *)(__mptr - offsetof(type, member))); })
</code></pre><pre tabindex="0"><code>// tools/include/linux/kernel.h

#ifndef offsetof
#define offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)
#endif
</code></pre><ol>
<li><code>offsetof</code> è®¡ç®—ç»“æ„ä½“ä¸­æŸä¸ªæˆå‘˜çš„åç§»é‡ï¼Œå…¶é€šè¿‡å¼ºè½¬å‡è®¾åœ°å€ 0 å¤„æœ‰ä¸€ä¸ª TYPE ç±»å‹çš„ç»“æ„ä½“ï¼Œ<code>-&gt;</code>æŒ‡é’ˆå–ç»“æ„ä½“æˆå‘˜ Memberï¼Œæœ€åé€šè¿‡ <code>&amp;</code> è·å¾— Member çš„åœ°å€ï¼Œå¹¶å¼ºè½¬ä¸º <code>size_t</code> ç±»å‹ã€‚</li>
<li><code>container_of</code> åˆ©ç”¨æˆå‘˜æŒ‡é’ˆï¼Œè·å¾—ç»“æ„ä½“çš„æŒ‡é’ˆã€‚<strong>æˆå‘˜æŒ‡é’ˆ - æˆå‘˜çš„åç§»é‡=ç»“æ„ä½“æŒ‡é’ˆ</strong></li>
<li><code>list_entry</code> list_head ä½œä¸ºä¸€ä¸ªæˆå‘˜åµŒå…¥åˆ°ç»“æ„ä½“ä¸­ï¼Œå·²çŸ¥ list_head æŒ‡é’ˆï¼Œè°ƒç”¨ <code>container_of</code> è·å¾—ç»“æ„ä½“æŒ‡é’ˆã€‚</li>
</ol>
<h2 id="äºŒhash-é“¾è¡¨">äºŒã€hash é“¾è¡¨</h2>
<p>linux kernel ä¸­å®šä¹‰ <code>hlist_head</code> ç”¨ä½œ hash è¡¨ä¸­çš„é“¾è¡¨å¤´ï¼Œ<code>hlist_node</code> ç”¨ä½œé“¾è¡¨ä¸­çš„æŸä¸€é¡¹ã€‚</p>
<pre tabindex="0"><code>// include/linux/types.h

struct hlist_head {
	struct hlist_node *first;
};

struct hlist_node {
	struct hlist_node *next, **pprev;
};
</code></pre><center><img src="https://img.jaxwang.top/2025/04/743a01bbad60899615e2f1507da5f383.png" width="70%" height="70%"></center>
<p>Linux kernel è®¾è®¡ <code>hlist_head</code> ä»…åŒ…å«ä¸€ä¸ªæŒ‡é’ˆç”¨ä½œ hash_table ä¸­çš„åˆ—è¡¨å¤´ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœå¾ˆå¤§ç©ºé—´ï¼Œç‰¹åˆ«æ˜¯å½“ hash bucket å¾ˆå¤§çš„æ—¶å€™ï¼Œå¯ä»¥èŠ‚çœä¸€åŠç©ºé—´ã€‚</p>
<p>æ•£åˆ—è¡¨çš„å†²çªæƒ…å†µå¾ˆå°‘ï¼Œé“¾è¡¨ä¸ä¼šå¾ˆé•¿ï¼Œéå†å¾ˆå¿«ã€‚å°† <code>pprev</code> è®¾è®¡ä¸ºæŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ <code>next</code> å¾ˆå®¹æ˜“å®ç°åˆ é™¤æ“ä½œã€‚</p>
<pre tabindex="0"><code>// include/linux/list.h

static inline void __hlist_del(struct hlist_node *n)
{
	struct hlist_node *next = n-&gt;next;
	struct hlist_node **pprev = n-&gt;pprev;

	WRITE_ONCE(*pprev, next);
	if (next)
		WRITE_ONCE(next-&gt;pprev, pprev);
}
</code></pre><h1 id="ref">Ref</h1>
<p><a href="https://blog.csdn.net/weixin_39094034/article/details/104803967">https://blog.csdn.net/weixin_39094034/article/details/104803967</a></p>
<p><a href="https://linux.laoqinren.net/kernel/hlist/">https://linux.laoqinren.net/kernel/hlist/</a></p>

</main>
</div>

<br>

  <footer>
  <hr/>
  
  
  <hr/>
  Â© <a href="https://jaxwang28.github.io">Jackson Wang</a> 2022 &ndash; 2025 | <a href="https://github.com/jaxwang28">Github</a>
  
  </footer>
  </body>
</html>

